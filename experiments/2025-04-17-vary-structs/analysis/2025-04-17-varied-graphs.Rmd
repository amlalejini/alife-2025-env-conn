# Avida - Varied graph structure experiment analyses

## Dependencies and setup

```{r}
library(tidyverse)
library(cowplot)
library(RColorBrewer)
library(khroma)
library(rstatix)
library(knitr)
library(kableExtra)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
```

```{r}
# Check if Rmd is being compiled using bookdown
bookdown <- exists("bookdown_build")
```

```{r}
experiment_slug <- "2025-04-17-vary-structs"
working_directory <- paste(
  "experiments",
  experiment_slug,
  "analysis",
  sep = "/"
)
# Adjust working directory if being knitted for bookdown build.
if (bookdown) {
  working_directory <- paste0(
    bookdown_wd_prefix,
    working_directory
  )
}

```

```{r}
# Configure our default graphing theme
theme_set(theme_cowplot())
# Create a directory to store plots
plot_dir <- paste(
  working_directory,
  "plots",
  sep = "/"
)

dir.create(
  plot_dir,
  showWarnings = FALSE
)
```

```{r}
focal_graphs <- c(
  "star",
  "random-waxman",
  "comet-kite",
  "linear-chain",
  "cycle",
  "clique-ring",
  "toroidal-lattice",
  "well-mixed",
  "wheel",
  "windmill"
)

# Load summary data from final update
data_path <- paste(
  working_directory,
  "data",
  "summary.csv",
  sep = "/"
)
data <- read_csv(data_path)

data <- data %>%
  mutate(
    graph_type = factor(
      graph_type,
      levels = c(
        "star",
        "random-waxman",
        "comet-kite",
        "linear-chain",
        "cycle",
        "clique-ring",
        "toroidal-lattice",
        "well-mixed",
        "wheel",
        "windmill"
      )
    ),
    ENVIRONMENT_FILE = as.factor(ENVIRONMENT_FILE)
  )
data <- data %>% filter(
  graph_type %in% focal_graphs
)
data <- data %>% filter(reached_target_update)
```

```{r}
time_series_path <- paste(
  working_directory,
  "data",
  "time_series.csv",
  sep = "/"
)
time_series_data <- read_csv(time_series_path)

time_series_data <- time_series_data %>%
  mutate(
    graph_type = factor(
      graph_type,
      levels = c(
        "star",
        "random-waxman",
        "comet-kite",
        "linear-chain",
        "cycle",
        "clique-ring",
        "toroidal-lattice",
        "well-mixed",
        "wheel",
        "windmill"
      )
    ),
    ENVIRONMENT_FILE = as.factor(ENVIRONMENT_FILE),
    seed = as.factor(seed)
  )
time_series_data <- time_series_data %>% filter(seed %in% data$seed)
time_series_data <- time_series_data %>% filter(
  graph_type %in% focal_graphs
)
```


```{r}
# Check that all runs completed
data %>%
  filter(update == 400000) %>%
  group_by(graph_type) %>%
  summarize(
    n = n()
  )
```


## Number of tasks completed

```{r}
pop_tasks_total_plt <- ggplot(
  data = data,
  mapping = aes(
    x = graph_type,
    y = pop_task_total,
    fill = graph_type
  )
) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/pop_tasks_total.pdf"),
  plot = pop_tasks_total_plt,
  width = 15,
  height = 10
)

pop_tasks_total_plt
```

```{r}
data %>%
  group_by(graph_type) %>%
  summarize(
    reps = n(),
    median_pop_tasks = median(pop_task_total),
    mean_pop_tasks = mean(pop_task_total)
  ) %>%
  arrange(
    desc(mean_pop_tasks)
  )
```

```{r}
kruskal.test(
  formula = pop_task_total ~ graph_type,
  data = data
)

wc_results <- pairwise.wilcox.test(
  x = data$pop_task_total,
  g = data$graph_type,
  p.adjust.method	= "holm",
  exact = FALSE
)

pop_task_wc_table <- kbl(wc_results$p.value) %>% kable_styling()
save_kable(pop_task_wc_table, paste0(plot_dir, "/pop_task_wc_table.pdf"))
pop_task_wc_table
```

## Dominant tasks

```{r}
dom_tasks_total_plt <- ggplot(
  data = data,
  mapping = aes(
    x = graph_type,
    y = dom_task_total,
    fill = graph_type
  )
) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/dom_tasks_total.pdf"),
  plot = dom_tasks_total_plt,
  width = 15,
  height = 10
)

dom_tasks_total_plt
```

```{r}
data %>%
  group_by(graph_type) %>%
  summarize(
    reps = n(),
    median_dom_task_total = median(dom_task_total),
    mean_dom_task_total = mean(dom_task_total)
  ) %>%
  arrange(
    desc(mean_dom_task_total)
  )
```

```{r}
kruskal.test(
  formula = dom_task_total ~ graph_type,
  data = data
)

wc_results <- pairwise.wilcox.test(
  x = data$dom_task_total,
  g = data$graph_type,
  p.adjust.method	= "holm",
  exact = FALSE
)

dom_task_total_wc_table <- kbl(wc_results$p.value) %>% kable_styling()
save_kable(dom_task_total_wc_table, paste0(plot_dir, "/dom_task_total_wc_table.pdf"))
dom_task_total_wc_table
```

Tasks done by organisms not in dominant taxon:


```{r}
data <- data %>%
  mutate(
    nondom_pop_task_prop = case_when(
      pop_task_total == 0 ~ 0,
      .default = (pop_task_total - dom_task_total) / (pop_task_total)
    )
  )

nondom_tasks_total_plt <- ggplot(
    data = data,
    mapping = aes(
      x = graph_type,
      y = nondom_pop_task_prop,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/non_dom_tasks_total.pdf"),
  plot = nondom_tasks_total_plt,
  width = 15,
  height = 10
)

nondom_tasks_total_plt
```

```{r}
data %>%
  group_by(graph_type) %>%
  summarize(
    reps = n(),
    median_nondom_pop_task_prop = median(nondom_pop_task_prop),
    mean_nondom_pop_task_prop = mean(nondom_pop_task_prop)
  ) %>%
  arrange(
    desc(mean_nondom_pop_task_prop)
  )
```

```{r}
kruskal.test(
  formula = nondom_pop_task_prop ~ graph_type,
  data = data
)

wc_results <- pairwise.wilcox.test(
  x = data$nondom_pop_task_prop,
  g = data$graph_type,
  p.adjust.method	= "holm",
  exact = FALSE
)

nondom_pop_task_prop_wc_table <- kbl(wc_results$p.value) %>% kable_styling()
save_kable(nondom_pop_task_prop_wc_table, paste0(plot_dir, "/nondom_pop_task_prop_wc_table.pdf"))
nondom_pop_task_prop_wc_table
```


```{r}
# kruskal.test(
#   formula = dom_task_total ~ graph_type,
#   data = filter(completed_runs_data)
# )
```

## Dominant gestation time

```{r}
dom_gestation_time_plt <- ggplot(
    data = data,
    mapping = aes(
      x = graph_type,
      y = dom_detail_gestation_time,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/dom_gestation_time.pdf"),
  plot = dom_gestation_time_plt,
  width = 15,
  height = 10
)

dom_gestation_time_plt
```

```{r}
data %>%
  group_by(graph_type) %>%
  summarize(
    reps = n(),
    median_dom_detail_gestation_time = median(dom_detail_gestation_time),
    mean_dom_detail_gestation_time = mean(dom_detail_gestation_time)
  ) %>%
  arrange(
    desc(mean_dom_detail_gestation_time)
  )
```

```{r}
kruskal.test(
  formula = dom_detail_gestation_time ~ graph_type,
  data = data
)

wc_results <- pairwise.wilcox.test(
  x = data$dom_detail_gestation_time,
  g = data$graph_type,
  p.adjust.method	= "holm",
  exact = FALSE
)

dom_detail_gestation_time_wc_table <- kbl(wc_results$p.value) %>% kable_styling()
save_kable(dom_detail_gestation_time_wc_table, paste0(plot_dir, "/dom_detail_gestation_time_wc_table.pdf"))
dom_detail_gestation_time_wc_table
```

## Dominant genome length

```{r}
dom_genome_length_plt <- ggplot(
    data = data,
    mapping = aes(
      x = graph_type,
      y = dom_detail_genome_length,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/dom_genome_length.pdf"),
  plot = dom_genome_length_plt,
  width = 15,
  height = 10
)

dom_genome_length_plt
```

```{r}
data %>%
  group_by(graph_type) %>%
  summarize(
    reps = n(),
    median_dom_detail_genome_length = median(dom_detail_genome_length),
    mean_dom_detail_genome_length = mean(dom_detail_genome_length)
  ) %>%
  arrange(
    desc(mean_dom_detail_genome_length)
  )
```

```{r}
kruskal.test(
  formula = dom_detail_genome_length ~ graph_type,
  data = data
)

wc_results <- pairwise.wilcox.test(
  x = data$dom_detail_genome_length,
  g = data$graph_type,
  p.adjust.method	= "holm",
  exact = FALSE
)

dom_detail_genome_length_wc_table <- kbl(wc_results$p.value) %>% kable_styling()
save_kable(dom_detail_genome_length_wc_table, paste0(plot_dir, "/dom_detail_genome_length_wc_table.pdf"))
dom_detail_genome_length_wc_table
```

## Task profile entropy

```{r}
task_profile_entropy_plt <- ggplot(
    data = data,
    mapping = aes(
      x = graph_type,
      y = task_profile_entropy,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/task_profile_entropy.pdf"),
  plot = task_profile_entropy_plt,
  width = 15,
  height = 10
)

task_profile_entropy_plt
```

```{r}
task_profile_count_plt <- ggplot(
    data = data,
    mapping = aes(
      x = graph_type,
      y = task_profile_count,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/task_profile_count.pdf"),
  plot = task_profile_count_plt,
  width = 15,
  height = 10
)

task_profile_count_plt
```

## Average generation

```{r}
avg_generation_plt <- ggplot(
    data = data,
    mapping = aes(
      x = graph_type,
      y = time_average_generation,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/avg_generation.pdf"),
  plot = avg_generation_plt,
  width = 15,
  height = 10
)

avg_generation_plt
```

## Population task count over time

```{r}
pop_task_cnt_ts <- ggplot(
    data = time_series_data,
    mapping = aes(
      x = update,
      y = pop_task_total_tasks_done,
      color = graph_type,
      fill = graph_type
    )
  ) +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(
    fun.data = "mean_cl_boot",
    fun.args = list(conf.int = 0.95),
    geom = "ribbon",
    alpha = 0.2,
    linetype = 0
  ) +
  theme(legend.position = "bottom")

ggsave(
  plot = pop_task_cnt_ts,
  filename = paste0(
    working_directory,
    "/plots/pop_tasks_ts.pdf"
  ),
  width = 15,
  height = 10
)

pop_task_cnt_ts
```

## Average generation over time

```{r}
time_average_generation_ts <- ggplot(
    data = time_series_data,
    mapping = aes(
      x = update,
      y = time_average_generation,
      color = graph_type,
      fill = graph_type
    )
  ) +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(
    fun.data = "mean_cl_boot",
    fun.args = list(conf.int = 0.95),
    geom = "ribbon",
    alpha = 0.2,
    linetype = 0
  ) +
  facet_wrap(~ENVIRONMENT_FILE) +
  theme(legend.position = "bottom")

ggsave(
  plot = time_average_generation_ts,
  filename = paste0(
    working_directory,
    "/plots/time_average_generation_ts.pdf"
  ),
  width = 15,
  height = 10
)

time_average_generation_ts
```


## Graph location info

Analyze graph_birth_info_annotated.csv

```{r}
# Load summary data from final update
graph_loc_data_path <- paste(
  working_directory,
  "data",
  "graph_birth_info_annotated.csv",
  sep = "/"
)
graph_loc_data <- read_csv(graph_loc_data_path)

graph_loc_data <- graph_loc_data %>%
  mutate(
    graph_type = factor(
      graph_type,
      levels = c(
        "star",
        "random-waxman",
        "comet-kite",
        "linear-chain",
        "cycle",
        "clique-ring",
        "toroidal-lattice",
        "well-mixed",
        "wheel",
        "windmill"
      )
    ),
    seed = as.factor(seed)
  ) %>%
  filter(
    graph_type %in% focal_graphs
  )

```

Summarize by seed
```{r}
graph_loc_data_summary <- graph_loc_data %>%
  group_by(seed, graph_type) %>%
  summarize(
    births_var = var(births),
    births_total = sum(births),
    task_apps_total = sum(task_appearances),
    task_apps_var = var(task_appearances)
  ) %>%
  ungroup()
```

### Total birth Counts

```{r}
birth_counts_total_plt <- ggplot(
    data = graph_loc_data_summary,
    mapping = aes(
      x = graph_type,
      y = births_total,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/birth_counts_total.pdf"),
  plot = birth_counts_total_plt,
  width = 15,
  height = 10
)

birth_counts_total_plt
```

### Variance birth Counts

```{r}
birth_counts_var_plt <- ggplot(
    data = graph_loc_data_summary,
    mapping = aes(
      x = graph_type,
      y = births_var,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/birth_counts_var.pdf"),
  plot = birth_counts_var_plt,
  width = 15,
  height = 10
)

birth_counts_var_plt
```

### Task appearances total

```{r}
task_apps_total_plt <- ggplot(
    data = graph_loc_data_summary,
    mapping = aes(
      x = graph_type,
      y = task_apps_total,
      fill = graph_type
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8
  ) +
  geom_point(
    mapping=aes(color = graph_type),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(
      angle = 30,
      hjust = 1
    )
  )

ggsave(
  filename = paste0(plot_dir, "/task_apps_total.pdf"),
  plot = task_apps_total_plt,
  width = 15,
  height = 10
)

task_apps_total_plt
```

```{r}
kruskal.test(
  formula = task_apps_total ~ graph_type,
  data = graph_loc_data_summary
)

wc_results <- pairwise.wilcox.test(
  x = graph_loc_data_summary$task_apps_total,
  g = graph_loc_data_summary$graph_type,
  p.adjust.method	= "holm",
  exact = FALSE

)
wc_results
```